# fotoware-http-get-by-id-fastapi

Goal: use regular, unauthenticated GET requests to retrieve a Fotoware asset.

Complication: there is no single, archive-independent identifier that can be queries for.
There is an archive-dependent file path and there is an implementation-internal `physicalFileId`.
This service enables GET requests, can assign identifiers and more.

Besides the cache, this service is completely stateless. That allows all configuration to be contained for easy deployment.

## Configuration and usage

- Provide environment variables ([required and optional](app/config.py))
- `$ docker compose up -d --build`
- `$ curl -X GET http://localhost:5001/doc/t3aiii6jyurgaxfcgn43qji3zh4/flower.jpg`

Use a reverse proxy (e.g., Caddy) to serve this app.

## Documentation

In production mode:

1. `GET /id/{identifier}` redirects to `/doc/{identifier}/{filename}`
1. `GET /doc/{identifier}/{filename}` renders the original file[¹](#fn1)
1. `GET /img/{identifier}/preview/{filename}?size,width,height,square` renders a preview (images and documents)
1. `GET /img/{identifier}/rendition/{filename}?profile,size,width,height` renders a specific rendition (images only)
1. `GET /-/background-worker/jsonld-manifest` returns a complete JSON-LD manifest of all files in the repository
1. `GET /-/background-worker/assign-metadata` sets IDs, hashes, etc. for assets that don't have them yet
1. `POST /-/webhooks/assign-metadata` calculates IDs, hashes, etc. for a single asset supplied via webhook

In development mode:

1. `GET /json/{identifier}/{filename}` renders the API's JSON response of the file
1. `GET /fotoweb` proxies the entire Fotoware application
1. `GET /-/tokens/new` returns new, temporarily valid tokens
1. `GET /-/docs/swagger` and `GET /-/docs/redoc` supply OpenAPI documentation on the whole service

The required and optional environment variables are listed and documented in [`app/config.py`](app/config.py).
Please check the optionals `FOTOWARE_ARCHIVES`, `FOTOWARE_FIELDNAME_UUID`, `PUBLIC_DOCTYPES` and `RATE_LIMIT` and set them to a reasonable default for your usecase, as well as an adequate cache size for memcached.

The **autogenerated ID** is a UUID in lowercase Base32, prefixed with random consonant.
If the URL-path supplied identifier is not found, error 404 is returned.
If there are multiple results for the identifier, error 404 is returned and a warning is written to the log.
This ensures that the ID is truly unique and prevents indeterminate, undefined behavior.

**Authentication** or authorization of the service to Fotoware is done by a client-id and secret. End-user access to files depends on what is configures as public. If not public, authorization is passed by means of JWTs, that are supplied either via the query parameter `?token=` or with the appropriate HTTP header (Bearer). A token is required on all production endpoints, except `GET /id/{identifier}`. During testing, use `/-/tokens/new` to generate access tokens.[²](#fn2)
The [token generation algorithm](#tokens) is described below.

As this service tries to be stateless, no services that provide token are registerd. Instead, linking services should use the `/id/{identifier}` or `/doc/{identifier}/{filename}` to find a public file OR generate their own tokens.

---

<a id="fn1" href="#fn1">1:</a> Unauthenticated only for the public document types configured in `PUBLIC_DOCTYPES` or `PUBLIC_METADATA_KEY_VALUE`. Else, a HTML and JSON-LD preview is supplied of the file with a link to Fotoware. Supply a token to show the file immediately.
<a id="fn2" href="#fn2">2:</a> You can configure the webhook with a long-lasting token from this page, but that would require to have set `JWT_SECRET`.

## Development

- A (VS Code) devcontainer is contained with this repository.
- `$ docker compose up --build`

## Tokens

The JWT token contains three claims, signed with a previously shared secret (`JWT_SECRET`).
The `exp` and `iat` claims are as JWT specifies them.
Ensure that the validity duration does not exceed the value of `TOKEN_MAX_DURATION`.

The `sub` claims concatenates a type (see `TokenAud`), `:`, and the file identifier.
The audience types and the algorithm for the construction of the token can be verified in [apptoken.py](app/apptoken.py).

## Known issues

Using UNION archives, the same file may appear with the same attributes and filename, yet in different archives.
Ensure that a single asset
